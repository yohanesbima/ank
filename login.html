<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('css'); ?>

  <style>
    /* === PAGE BASE === */
    body.login-page {
      background: url('https://raw.githubusercontent.com/yohanesbima/ank/main/ank_rawa.png') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Inter', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      position: relative;
      overflow: hidden;
    }

    body.login-page::before {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(255,255,255,0.55);
      z-index: 0;
      transition: 0.4s ease;
    }

    body.login-page.dark-mode::before {
      background: rgba(0,0,0,0.55);
    }

    /* WATERMARK */
    .watermark {
      position: fixed;
      z-index: 9998;
      opacity: 0;
      width: 300px;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      transition: opacity 1.5s ease-in-out;
      pointer-events: none;
    }

    /* SPLASH SCREEN */
    #splash {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.88);
      backdrop-filter: blur(9px);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.8s ease;
    }

    #splash.show {
      opacity: 1;
      pointer-events: all;
    }

    #splash img {
      width: 150px;
      margin-bottom: 20px;
      animation: floatUp 1.2s ease-out forwards;
      opacity: 0;
    }

    #splash .welcome-text {
      font-size: 22px;
      font-weight: 700;
      color: #333;
      opacity: 0;
      animation: fadeText 1.4s ease-out forwards 0.4s;
    }

    @keyframes floatUp {
      from { transform: translateY(20px); opacity: 0; }
      to   { transform: translateY(0); opacity: 1; }
    }

    @keyframes fadeText {
      from { opacity: 0; }
      to   { opacity: 1; }
    }

    /* === LOGIN BOX === */
    .login-container {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 400px;
      background: rgba(255,255,255,0.92);
      padding: 40px 40px;
      border-radius: 18px;
      box-shadow: 0 6px 25px rgba(0,0,0,0.15);
      backdrop-filter: blur(6px);
      animation: fadeSlideIn 0.6s ease-out forwards;
      text-align: center;
      opacity: 0;
      transform: translateY(30px);
    }

    @keyframes fadeSlideIn {
      to { opacity: 1; transform: translateY(0); }
    }

    .logo {
      width: 120px;
      display: block;
      margin: 0 auto 15px auto;
    }

    h2 {
      margin: 0 0 25px;
      font-size: 22px;
      font-weight: 700;
      color: #3e3e3e;
    }

    label {
      text-align: left;
      display: block;
      font-weight: 500;
      margin-bottom: 6px;
      color: #444;
    }

    select, input[type="text"], input[type="password"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      margin-bottom: 18px;
      background: #fff;
    }

    .password-container { position: relative; }
    .toggle-pass {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      font-size: 15px;
    }

    .remember {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 5px 0 20px;
      font-size: 14px;
    }

    .remember input {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #6b4f35;
    }

    button {
      width: 100%;
      background: #6b4f35;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover:not(:disabled) {
      background: #5a422c;
      transform: scale(1.02);
    }

    button:disabled { opacity: 0.6; }

    .theme-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.85);
      font-size: 22px;
      cursor: pointer;
      z-index: 10;
    }

    #msg {
      margin-top: 12px;
      font-size: 14px;
      color: #d9534f;
      text-align: center;
    }

    /* SHAKE ERROR */
    @keyframes shake {
      0% { transform: translateX(0); }
      20% { transform: translateX(-8px); }
      40% { transform: translateX(8px); }
      60% { transform: translateX(-5px); }
      80% { transform: translateX(5px); }
      100% { transform: translateX(0); }
    }
    .shake { animation: shake 0.45s ease; }

    /* LOADER DOTS */
    .loader-dots {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      height: 18px;
    }

    .loader-dots span {
      width: 6px;
      height: 6px;
      background: #fff;
      border-radius: 50%;
      display: inline-block;
      animation: dotPulse 1.4s infinite ease-in-out;
    }

    .loader-dots span:nth-child(1) { animation-delay: 0s; }
    .loader-dots span:nth-child(2) { animation-delay: 0.2s; }
    .loader-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes dotPulse {
      0%, 80%, 100% { transform: scale(0.4); opacity: 0.4; }
      40% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>

<body class="login-page">

  <!-- WATERMARK -->
  <img id="watermark" class="watermark" 
       src="https://raw.githubusercontent.com/yohanesbima/ank/main/WhatsApp%20Image%202025-11-09%20at%2003.17.03.png">

  <!-- SPLASH -->
  <div id="splash">
    <img src="https://raw.githubusercontent.com/yohanesbima/ank/main/WhatsApp%20Image%202025-11-09%20at%2003.17.03.png">
    <div class="welcome-text" id="welcomeText">Welcome!</div>
  </div>

  <!-- LOGIN CARD -->
  <div class="login-container" id="loginBox">

    <img src="https://raw.githubusercontent.com/yohanesbima/ank/main/WhatsApp%20Image%202025-11-09%20at%2003.17.03.png" class="logo">

    <h2>Atasnama Kopi - Express</h2>

    <form id="loginForm" onsubmit="login(event)">

      <label>Pilih Role</label>
      <select id="role" onchange="updateFeatureList()">
        <option value="rider">Rider</option>
        <option value="admin">Admin</option>
      </select>

      <label>Pilih Fitur</label>
      <select id="feature"></select>

      <label>Nama</label>
      <input type="text" id="name" placeholder="Masukkan nama">

      <label>Password</label>
      <div class="password-container">
        <input type="password" id="password" placeholder="Masukkan password">
        <span class="toggle-pass" onclick="togglePassword()">üëÅÔ∏è</span>
      </div>

      <div class="remember">
        <input type="checkbox" id="rememberMe">
        <label for="rememberMe">Ingat saya</label>
      </div>

      <button id="loginBtn">Login</button>
      <p id="msg"></p>

    </form>
  </div>

  <button class="theme-toggle" id="themeToggle">üåô</button>

  <script>

    /* PASSWORD TOGGLE */
    function togglePassword(){
      const p = document.getElementById("password");
      p.type = p.type === "password" ? "text" : "password";
    }

    /* FITUR BY ROLE */
function updateFeatureList(){
  const role = document.getElementById("role").value;
  const f = document.getElementById("feature");
  f.innerHTML = "";

  if(role === "rider"){
    f.innerHTML += `<option value="refill">Form Refill Product</option>`;
  }

  if(role === "admin"){
    f.innerHTML += `<option value="rider">Form Rider (Sales Harian)</option>`;
    f.innerHTML += `<option value="refill">Form Refill Product</option>`;
    f.innerHTML += `<option value="stock_admin">Form Update Stock</option>`;
    f.innerHTML += `<option value="analytics">Admin Dashboard (Coming Soon)</option>`;
  }
}
updateFeatureList();


    /* THEME */
    const body = document.body;
    const tBtn = document.getElementById("themeToggle");
    const savedTheme = localStorage.getItem("theme");

    if(savedTheme === "dark"){
      body.classList.add("dark-mode");
      tBtn.textContent = "‚òÄÔ∏è";
    }

    tBtn.onclick = ()=>{
      body.classList.toggle("dark-mode");
      const dark = body.classList.contains("dark-mode");
      tBtn.textContent = dark ? "‚òÄÔ∏è" : "üåô";
      localStorage.setItem("theme", dark ? "dark" : "light");
    };

    /* ROLE-BASED GREETING */
    function getGreeting(fullname, role){
      const riderLines = [
        `‚òï ${fullname}, gas narik dulu biar hari makin manis!`,
        `üö¥‚Äç‚ôÇÔ∏è Semangat narik hari ini, ${fullname}!`,
        `üî• ${fullname}, cuan hari ini lagi nunggu kamu.`,
        `üí™ Jangan lupa senyum, ${fullname}. Rejeki banyak hari ini.`,
        `üå§Ô∏è ${fullname}, kopi boleh pahit tapi harimu jangan.`,
      ];

      const adminLines = [
        `üìä Selamat bekerja ${fullname}.`,
        `üßÅ ${fullname}, kamu bikin operasional makin rapi.`,
        `‚òï ${fullname}, energi admin kuat banget hari ini.`,
        `üõ†Ô∏è ${fullname}, mari kita rapihin hari ini satu-satu.`,
        `üöÄ ${fullname}, dashboard nunggu kehadiranmu.`,
      ];

      const list = role === "admin" ? adminLines : riderLines;
      return list[Math.floor(Math.random() * list.length)];
    }

    /* LOGIN */
    function login(event){
      event.preventDefault();

      let role = document.getElementById("role").value;
      let feature = document.getElementById("feature").value;
      let name = document.getElementById("name").value.trim().toLowerCase();
      let pass = document.getElementById("password").value.trim().toLowerCase();
      let remember = document.getElementById("rememberMe").checked;

      let msg = document.getElementById("msg");
      let btn = document.getElementById("loginBtn");

      if(!name || !pass){
        msg.textContent = "‚ö†Ô∏è Nama dan password wajib diisi.";
        return;
      }

      btn.disabled = true;

      /* LOADER DOTS */
      btn.innerHTML = `
        <div class="loader-dots">
          <span></span><span></span><span></span>
        </div>
      `;

      google.script.run.withSuccessHandler(res=>{
        btn.disabled = false;
        btn.innerHTML = "Login";

        /* LOGIN SUKSES */
        if(res.success){

          if(remember){
            localStorage.setItem("savedName", name);
            localStorage.setItem("savedRole", role);
          }

          google.script.run.withSuccessHandler(fullname => {

            const greet = getGreeting(fullname, role);
            document.getElementById("welcomeText").textContent = greet;
            document.getElementById("splash").classList.add("show");

            setTimeout(() => {
              document.getElementById("watermark").style.opacity = "0.15";
            }, 400);

            setTimeout(()=>{
              google.script.run.withSuccessHandler(html=>{
                document.open(); document.write(html); document.close();
              }).getPage(feature);
            }, 1800);

          }).getUserName();

        }

        /* LOGIN GAGAL */
        else {
          msg.textContent = "‚ùå Kayaknya role kamu salah atau password salah.";
          const box = document.getElementById("loginBox");
          box.classList.add("shake");
          setTimeout(()=> box.classList.remove("shake"), 500);
        }

      }).checkLogin(role, name, pass);
    }
  </script>

</body>
</html>

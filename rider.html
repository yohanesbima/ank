<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Form Penjualan Rider</title>

  <style>
    /* Tambahkan ini di dalam tag <style> yang sudah ada */
  .merged-cell {
    vertical-align: middle !important;
    background-color: #F3E5F5; /* Warna ungu muda (cash-section) */
  }
  
  /* Input di dalam merged cell dibuat lebih besar sedikit */
  .merged-input {
    width: 100% !important;
    height: 100% !important;
    min-height: 60px; /* Biar enak diklik */
    font-weight: bold;
    font-size: 16px !important;
    text-align: center !important;
    border: none !important;
    background: transparent !important;
  }
  
  .merged-input:focus {
    background: #fff !important;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
  }
    :root{
      --brown:#795548; --brown-dark:#5d4037; --beige:#fffdf8; --bg:#f3f2ef;
      --muted:#d7ccc8; --accent:#43a047; --radius:12px; --panel-radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Poppins",sans-serif;background:var(--bg);color:#3e2723;-webkit-font-smoothing:antialiased;}

    /* marquee & header */
    .marquee-container{background:var(--brown);color:#fff8e1;padding:6px 0;overflow:hidden;white-space:nowrap;}
    .marquee-text{display:inline-block;padding-left:100%;animation:marquee 18s linear infinite;}
    @keyframes marquee{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}
    .header{display:flex;align-items:center;gap:14px;background:linear-gradient(#6d4c41,#5d4037);color:#fff;padding:14px 22px;box-shadow:0 4px 14px rgba(0,0,0,.1)}
    .header img{width:42px;height:42px;border-radius:10px}
    .header h1{font-size:19px;margin:0;font-weight:600}

    /* form container */
    .form-container{max-width:1200px;margin:26px auto;background:#fff;border-radius:var(--panel-radius);padding:26px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
    h2{text-align:center;margin:4px 0 24px;color:var(--brown);font-size:22px}

    .input-group{display:flex;flex-direction:column;gap:6px}
    .input-group label{font-size:13px;font-weight:600;color:#4e342e}
    input[list],input[type="text"],input[type="date"],select,textarea{padding:10px 12px;font-size:14px;border:1px solid var(--muted);border-radius:8px;background:var(--beige);height:42px;transition:.2s}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--brown);box-shadow:0 0 6px rgba(121,85,72,0.18)}

    .top-form{display:flex;flex-direction:column;gap:24px}
    .top-form .row{display:grid;grid-template-columns:repeat(4,1fr);gap:20px}
    .top-form .small-row{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;width:60%;margin:0 auto}
    @media(max-width:980px){.top-form .row,.top-form .small-row{grid-template-columns:1fr;width:100%}}

.table-wrapper{
  width:100%;
  margin-top:16px;
  overflow-x:visible !important;   /* hilangin scroll */
  border-radius:var(--radius);
}

table{
  width:100%;
  min-width:unset !important;      /* hilangin batas min width */
  table-layout:auto;               /* biar kolom auto menyesuaikan */
  border-collapse:collapse;
  font-size:13px;
}

    th,td{border:1px solid #e5e3df;padding:7px 8px;text-align:center}
    th{background:var(--brown);color:#fff;position:sticky;top:0;font-weight:700;z-index:2}
    td:first-child{text-align:left;padding-left:12px;font-weight:500}

    .stock-section{background:#FFF3E0}.remain-section{background:#E3F2FD}
    .sales-section{background:#E8F5E9}.cash-section{background:#F3E5F5}

    #salesTable tr:hover td{background:#fff9c4!important}
    tfoot td{font-weight:700;background:#efefef}

    #salesTable input[type="text"],#salesTable textarea{width:100%;padding:6px 6px;font-size:13px;border-radius:6px;border:1px solid #ddd;background:#fff;text-align:right}
    #salesTable textarea{resize:none;text-align:left}
    .highlight{background:#C8E6C9!important;transition:background 1s}

    .bottom-inputs{display:grid;grid-template-columns:repeat(5,1fr);gap:18px;margin-top:18px}
    .bottom-inputs .input-group label{font-size:11px;font-weight:600}
    .bottom-inputs input{height:38px;padding:6px 8px;font-size:12px;border-radius:6px}

    .controls{display:flex;justify-content:center;margin-top:22px;gap:14px}
    .save-btn,.reset-btn{padding:10px 18px;border-radius:8px;font-weight:600;border:none;color:#fff;cursor:pointer;transition:.2s}
    .save-btn{background:var(--brown)}.save-btn:hover{background:var(--brown-dark)}
    .reset-btn{background:#607d8b}.reset-btn:hover{background:#455a64}

    .floating-save{position:fixed;right:20px;bottom:20px;width:56px;height:56px;border-radius:50%;background:var(--brown);box-shadow:0 6px 18px rgba(0,0,0,.12);color:#fff;border:none;font-size:20px;cursor:pointer;display:none;z-index:999}
    .popup{position:fixed;top:20px;right:20px;padding:12px 18px;background:var(--accent);color:white;border-radius:8px;opacity:0;transform:translateY(-12px);transition:all .3s;z-index:2000}
    .popup.show{opacity:1;transform:translateY(0)}

    /* SIDEBAR final */
    .histori-btn{position:fixed;top:120px;right:20px;background:#6d4c41;color:#fff;padding:10px 18px;border-radius:40px;font-size:14px;font-weight:600;border:none;cursor:pointer;box-shadow:0 3px 10px rgba(0,0,0,.25);z-index:10010;display:flex;align-items:center;gap:8px;transition:.18s}
    .histori-btn:hover{transform:translateY(-2px);background:#5d4037}

    #refillOverlay{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.12);z-index:10005;display:none}
    body.refill-open #refillOverlay{display:block}

    #refillSidebar{position:fixed;top:0;right:-420px;width:420px;height:100vh;background:#faf6f2;box-shadow:-6px 0 18px rgba(0,0,0,0.16);transition:right .28s ease;z-index:10020;overflow-y:auto;-webkit-overflow-scrolling:touch}
    #refillSidebar.open{right:0}

    .refill-header{position:sticky;top:0;z-index:10030;background:#faf6f2;border-bottom:1px solid #e6ddd8;padding:18px 18px}
    .refill-header h3{margin:0;font-size:20px;color:#5d4037;font-weight:700}

    .refill-summary{position:sticky;top:64px;z-index:10025;background:#efe7e2;border-radius:12px;padding:14px;margin:12px 14px;box-shadow:inset 0 0 4px rgba(0,0,0,0.03)}
    .product-summary-box{background:#fff;padding:12px;border-radius:10px;margin-top:8px;border:1px solid #e6ddd8;color:#4e342e;font-size:13px}
    .refill-item{background:#fff;border:1px solid #e0d7d2;padding:12px;border-radius:10px;margin:0 14px 14px;box-shadow:0 2px 6px rgba(0,0,0,0.04);color:#4e342e;font-size:13px}
    .close-refill{background:#8d6e63;color:#fff;border:none;padding:10px 16px;border-radius:10px;font-weight:600;cursor:pointer;margin:14px;width:calc(100% - 28px)}
    .close-refill:hover{background:#6d4c41}

    body.refill-open .histori-btn{display:none!important}

    @media(max-width:480px){#refillSidebar{width:100%} }
th, td {
  padding: 6px 4px;   /* lebih rapat */
/* highlight focus kuning */
.cell-focused {
  background-color: #fff9c4 !important;
  transition: background 0.15s ease;
}
}

.row-focused td {
  background-color: #fff9c4 !important;
  transition: background 0.18s ease;
}



  </style>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <div class="marquee-container"><div id="welcomeText" class="marquee-text">Hi Rider, semangat ya untuk hari ini ‚òï</div></div>
  <div class="header">
    <img src="https://raw.githubusercontent.com/yohanesbima/ank/main/WhatsApp%20Image%202025-11-09%20at%2003.17.03.png" alt="Logo">
    <h1>Atasnama Kopi ‚Äî Express</h1>
  </div>

  <!-- Floating button -->
  <button class="histori-btn" id="historiBtn">üì¶ Histori Refill</button>

  <!-- Overlay clickable -->
  <div id="refillOverlay" onclick="closeRefillSidebar()"></div>

  <!-- Sidebar -->
  <aside id="refillSidebar" aria-hidden="true">
    <div class="refill-header"><h3>Histori Refill</h3></div>

    <div id="refillSummary" class="refill-summary">Pilih Rider & Tanggal untuk melihat histori refill.</div>

    <!-- Product summary box (non-sticky, under main summary) -->
    <div id="productSummaryBox" class="product-summary-box" style="display:none;margin:0 14px 12px;"></div>

    <div id="refillList"></div>

    <button class="close-refill" onclick="closeRefillSidebar()">Tutup</button>
  </aside>

  <!-- Main form -->
  <div class="form-container">
    <h2>Form Penjualan Rider</h2>

    <div class="top-form">
      <div class="row">
        <div class="input-group">
          <label>Outlet</label>
          <select id="outletSelect">
            <option value="">-- Pilih Outlet --</option>
            <option value="Rawamangun">Rawamangun</option>
            <option value="Ciledug">Ciledug</option>
          </select>
        </div>

        <div class="input-group">
          <label>Nama Rider</label>
          <input list="riderList" id="riderName" placeholder="Pilih atau ketik nama rider...">
          <datalist id="riderList"></datalist>
        </div>

        <div class="input-group">
          <label>Lokasi</label>
          <input list="locationList" id="location" placeholder="Pilih atau ketik lokasi...">
          <datalist id="locationList"></datalist>
        </div>

        <div class="input-group">
          <label>No Gerobak</label>
          <input list="gerobakList" id="noGerobak" placeholder="Pilih atau ketik No Gerobak...">
          <datalist id="gerobakList"></datalist>
        </div>
      </div>

      <div class="row small-row">
        <div class="input-group">
          <label>Tanggal</label>
          <input type="date" id="date">
        </div>

        <div class="input-group">
          <label>Admin Checked By</label>
          <input list="adminList" id="adminCheckedBy" placeholder="Pilih atau ketik admin...">
          <datalist id="adminList"></datalist>
        </div>
      </div>
    </div>

    <!-- TABLE
         Columns: Produk | Harga | Stok Lama | Stok Baru | Total Refill | Total Awal | Sisa Lama | Sisa Baru | Total Sisa | Terjual | Pendapatan | Cash | QR | Catatan
    -->
    <div class="table-wrapper">
      <table id="salesTable">
        <thead>
          <tr>
            <th>Produk</th><th>Harga</th>
            <th>Stok Lama</th><th>Stok Baru</th>
            <th>Total Refill</th><th>Total Awal</th>
            <th>Sisa Lama</th><th>Sisa Baru</th><th>Total Sisa</th>
            <th>Terjual</th><th>Pendapatan</th><th>Cash</th><th>QR</th><th>Catatan</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot>
          <tr>
            <td colspan="2" style="text-align:right;">GRAND TOTAL</td>
            <td id="grandOldStock">0</td><td id="grandNewStock">0</td>
            <td id="grandTotalRefill">0</td><td id="grandTotalStart">0</td>
            <td id="grandRemainOld">0</td><td id="grandRemainNew">0</td><td id="grandTotalRemain">0</td>
            <td id="grandTotalSold">0</td><td id="grandTotalRevenue">0</td>
            <td id="grandTotalCash">0</td><td id="grandTotalQR">0</td><td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="bottom-inputs">
      <div class="input-group"><label>Cash Diterima</label><input type="text" id="cashDiterima" class="numeric"></div>
      <div class="input-group"><label>Cashbon</label><input type="text" id="cashbon" class="numeric" value="0"></div>
      <div class="input-group"><label>Minus</label><input type="text" id="minus" class="numeric" readonly></div>
      <div class="input-group"><label>Plus</label><input type="text" id="plus" class="numeric" readonly value="0"></div>
      <div class="input-group"><label>Notes / Catatan</label><input type="text" id="notesRider"></div>
    </div>

    <div class="controls">
      <button class="save-btn" id="saveBtn" onclick="validateAndSave()">üíæ Simpan Data</button>
      <button class="reset-btn" onclick="resetForm()">üÜï Input Baru</button>
      <span id="status" style="margin-left:12px;color:#444;font-weight:600"></span>
    </div>
  </div>

  <button class="floating-save" onclick="validateAndSave()">üíæ</button>
  <div id="popup" class="popup">‚úÖ Data berhasil disimpan</div>

  <script>
    /* ========== Helpers & master data ========== */
    google.script.run.withSuccessHandler(fullname=>{
      const name = fullname||"Rider";
      const normalTexts = [
        `‚òï Semangat kerja hari ini, ${name}!`,
        `üí™ Jalani hari dengan penuh semangat, ${name}!`,
        `üåû Selamat beraktivitas ${name}, tetap positif ya!`,
        `üö¥‚Äç‚ôÇÔ∏è Yuk ${name}, kita buat hari ini produktif!`
      ];
      document.getElementById("welcomeText").textContent = normalTexts[Math.floor(Math.random()*normalTexts.length)];
    }).getUserName();


function todayLocal() {
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}

let userInfo = {};
let MASTER = {};
MASTER.refillByProduct = {};

/* LOAD USER LOGIN INFO FIRST */
document.addEventListener("DOMContentLoaded", () => {
  google.script.run.withSuccessHandler(info => {
    userInfo = info || {};        // <-- simpan role + fullname dari GAS
    loadMasterData();             // <-- lanjut load master
  }).getUserLoginInfo();          // <-- pakai function punya delivery_refill
});


function loadMasterData() {
  google.script.run.withSuccessHandler(data => {
    MASTER = data;
    renderPage(data);
    lockAdminCheckedBy();      // <-- kunci admin setelah render
  }).getMasterData();
}

function lockAdminCheckedBy() {
  const adminField = document.getElementById("adminCheckedBy");
  if (!adminField) return;

  // Auto isi nama admin dari userProperties
  adminField.value = userInfo.fullname || userInfo.username || "";

  // Lock field (TIDAK disabled supaya terkirim ke backend)
  adminField.readOnly = true;
  adminField.style.background = "#eee";
  adminField.style.cursor = "not-allowed";
}


    function renderPage(d){
      MASTER = d || {};
      MASTER.ridersWithMeta = d.ridersWithMeta || [];
      MASTER.locations = d.locations || [];
      MASTER.gerobakList = d.gerobakList || [];

      renderDropdown(document.getElementById("adminList"), d.admins || []);
      renderDropdown(document.getElementById("riderList"), []);
      renderDropdown(document.getElementById("locationList"), []);
      renderDropdown(document.getElementById("gerobakList"), []);

      const outletEl = document.getElementById("outletSelect");
      if(outletEl) outletEl.addEventListener("change", applyOutletFilter);
      const dateEl = document.getElementById("date");
      if (dateEl) dateEl.value = todayLocal();
      renderProducts(d.products || []);
    }

    function renderDropdown(el,list){ if(!el) return; el.innerHTML=""; (list||[]).sort((a,b)=>String(a).localeCompare(String(b))).forEach(v=>{ const o=document.createElement("option"); o.value=v; el.appendChild(o); }); }

    function applyOutletFilter(){
      const outlet = document.getElementById("outletSelect").value;
      if(!outlet){ renderDropdown(document.getElementById("riderList"),[]); renderDropdown(document.getElementById("locationList"),[]); renderDropdown(document.getElementById("gerobakList"),[]); document.getElementById("noGerobak").value = ""; return; }
      const filteredRiders = MASTER.ridersWithMeta.filter(r=> (r.status||"").toLowerCase()==="aktif" && (r.outlet||"").toLowerCase()===outlet.toLowerCase()).map(r=>r.name);
      renderDropdown(document.getElementById("riderList"), filteredRiders);
      const filteredLocations = MASTER.locations.filter(l=>(l.outlet||"").toLowerCase()===outlet.toLowerCase()).map(l=>l.name);
      renderDropdown(document.getElementById("locationList"), filteredLocations);
      let prefix=""; if(outlet==="Rawamangun") prefix="rwm"; else if(outlet==="Ciledug") prefix="ecl";
      const filteredGerobak = MASTER.gerobakList.filter(g=>g.toLowerCase().includes(prefix));
      renderDropdown(document.getElementById("gerobakList"), filteredGerobak);
      document.getElementById("noGerobak").value = outlet==="Rawamangun" ? "RWM-" : outlet==="Ciledug" ? "ECL-" : "";
    }

    function formatNumber(v){ return isNaN(v)||v===""?"":Number(v).toLocaleString("en-US"); }
    function unformatNumber(v){ return Number((v||"").toString().replace(/,/g,""))||0; }

    /* ========== Render products (table rows) ========== */
    function renderProducts(products){
      const tb = document.getElementById("tableBody");
      tb.innerHTML = "";
      const count = (products||[]).length; // Hitung jumlah baris untuk rowspan

      (products||[]).forEach((p, index)=>{
        const tr = document.createElement("tr");
        
        // Logika HTML Biasa
        let rowHTML = `
          <td class="prod-name">${p.product}</td>
          <td><input type="text" class="price" value="${formatNumber(p.price)}" readonly></td>

          <td class="stock-section"><input type="text" class="oldStock numeric"></td>
          <td class="stock-section"><input type="text" class="newStock numeric"></td>

          <td class="stock-section"><input type="text" class="totalRefill" readonly></td>
          <td class="stock-section"><input type="text" class="totalStart" readonly></td>

          <td class="remain-section"><input type="text" class="remainOld numeric"></td>
          <td class="remain-section"><input type="text" class="remainNew numeric"></td>
          <td class="remain-section"><input type="text" class="totalRemain" readonly></td>

          <td class="sales-section"><input type="text" class="sold" readonly></td>
          <td class="sales-section"><input type="text" class="revenue" readonly></td>
        `;

        // Logika MERGE CELL (Hanya render kolom Cash & QR di baris pertama)
        if (index === 0) {
          rowHTML += `
            <td rowspan="${count}" class="merged-cell">
               <input type="text" id="globalCash" class="merged-input numeric" readonly placeholder="Auto">
            </td>
            <td rowspan="${count}" class="merged-cell">
               <input type="text" id="globalQR" class="merged-input numeric" placeholder="0">
            </td>
          `;
        } 
        // Baris selanjutnya TIDAK render kolom Cash & QR (karena sudah dimakan rowspan)

        rowHTML += `<td><textarea class="notes" rows="1"></textarea></td>`;
        
        tr.innerHTML = rowHTML;
        tb.appendChild(tr);
      });

      // Update refill values
      updateRefillOnProducts();
      
      // Tambahkan listener khusus untuk Global QR di sini setelah elemen dibuat
      const qrInput = document.getElementById("globalQR");
      if(qrInput) {
        qrInput.addEventListener("input", (e) => {
           // Format angka saat ngetik
           const raw = e.target.value.replace(/,/g,"");
           if(!isNaN(raw)) e.target.value = formatNumber(raw);
           
           updateGrandTotal(); // Trigger hitung ulang Cash
        });
      }
    }

    /* --- MODIFIED: INPUT LISTENER --- */
    document.addEventListener("input", e=>{
      // Numeric formatting standard
      if(e.target.classList.contains("numeric") && e.target.id !== "globalQR"){ // globalQR sudah dihandle khusus
        const raw = e.target.value.replace(/,/g,"");
        if(isNaN(raw)) e.target.classList.add("invalid");
        else { e.target.classList.remove("invalid"); e.target.value = formatNumber(raw); }
      }

      // Trigger hitungan baris
      if(["oldStock","newStock","remainOld","remainNew"].some(cls => e.target.classList.contains(cls))){
        calculateRow(e.target.closest("tr"));
        updateGrandTotal();
      }

      // Bottom inputs
      if(["cashDiterima","cashbon"].includes(e.target.id)) calculateMinus();
    });

    /* keyboard nav unchanged (keeps productivity) */
    document.addEventListener("keydown", e=>{
      const active = document.activeElement;
      if(!active || !active.matches("input,textarea")) return;
      const row = active.closest("tr"); if(!row) return;
      const allRows = Array.from(document.querySelectorAll("#tableBody tr")); const rowIndex = allRows.indexOf(row);
      const cellsInRow = Array.from(row.querySelectorAll("input,textarea")); const colIndex = cellsInRow.indexOf(active);
      let target = null;
      if(e.key === "ArrowRight") target = cellsInRow[colIndex+1];
      else if(e.key === "ArrowLeft") target = cellsInRow[colIndex-1];
      else if(e.key === "ArrowDown" || e.key === "Enter"){ const nextRow = allRows[rowIndex+1]; if(nextRow){ const nextCells = Array.from(nextRow.querySelectorAll("input,textarea")); target = nextCells[colIndex] || nextCells[nextCells.length-1]; } }
      else if(e.key === "ArrowUp"){ const prevRow = allRows[rowIndex-1]; if(prevRow){ const prevCells = Array.from(prevRow.querySelectorAll("input,textarea")); target = prevCells[colIndex] || prevCells[prevCells.length-1]; } }
      if(target){ e.preventDefault(); target.focus(); target.select(); }
    });

// focus highlight universal
document.addEventListener("focusin", (e) => {
  if (e.target.matches("input, textarea")) {
    // remove previous focus highlight
    document.querySelectorAll(".cell-focused").forEach(el =>
      el.classList.remove("cell-focused")
    );

    // add new highlight
    e.target.classList.add("cell-focused");
  }
});

document.addEventListener("focusout", (e) => {
  if (e.target.matches("input, textarea")) {
    e.target.classList.remove("cell-focused");
  }
});

document.addEventListener("focusin", (e) => {
  if (!e.target.matches("input, textarea")) return;

  const row = e.target.closest("tr");
  if (!row) return;

  // remove highlight dari row lain
  document.querySelectorAll(".row-focused").forEach(r =>
    r.classList.remove("row-focused")
  );

  // apply highlight ke row aktif
  row.classList.add("row-focused");
});


    /* --- MODIFIED: CALCULATE ROW (Hapus logic Cash/QR per row) --- */
    function calculateRow(r){
      if(!r) return;
      const price = unformatNumber(r.querySelector(".price").value);
      const oldS = unformatNumber(r.querySelector(".oldStock").value);
      const newS = unformatNumber(r.querySelector(".newStock").value);
      const prod = r.querySelector(".prod-name").textContent;
      const refill = Number(MASTER.refillByProduct && MASTER.refillByProduct[prod] ? MASTER.refillByProduct[prod] : 0);
      
      const rOld = unformatNumber(r.querySelector(".remainOld").value);
      const rNew = unformatNumber(r.querySelector(".remainNew").value);

      const totalStart = oldS + newS + refill;
      const totalRemain = rOld + rNew;
      const sold = totalStart - totalRemain;
      const revenue = sold * price;


      // Set values row
      r.querySelector(".totalStart").value = formatNumber(totalStart);
      r.querySelector(".totalRemain").value = formatNumber(totalRemain);
      r.querySelector(".sold").value = formatNumber(sold);
      r.querySelector(".revenue").value = formatNumber(revenue);
      
      // NOTE: Logic Cash & QR dihapus dari sini karena sekarang Global
    }

 /* --- MODIFIED: UPDATE GRAND TOTAL & GLOBAL LOGIC --- */
    function updateGrandTotal(){
      const t = {oldStock:0,newStock:0,totalRefill:0,totalStart:0,remainOld:0,remainNew:0,totalRemain:0,sold:0,revenue:0};
      
      document.querySelectorAll("#tableBody tr").forEach(r=>{
        t.oldStock += unformatNumber(r.querySelector(".oldStock").value);
        t.newStock += unformatNumber(r.querySelector(".newStock").value);
        t.totalRefill += unformatNumber(r.querySelector(".totalRefill").value);
        t.totalStart += unformatNumber(r.querySelector(".totalStart").value);
        t.remainOld += unformatNumber(r.querySelector(".remainOld").value);
        t.remainNew += unformatNumber(r.querySelector(".remainNew").value);
        t.totalRemain += unformatNumber(r.querySelector(".totalRemain").value);
        t.sold += unformatNumber(r.querySelector(".sold").value);
        t.revenue += unformatNumber(r.querySelector(".revenue").value);
      });

      // --- LOGIC BARU: HITUNG CASH OTOMATIS ---
      // Ambil nilai QR Global yg diinput user
      const globalQRVal = unformatNumber(document.getElementById("globalQR").value);
      
      // Hitung Cash Global = Total Pendapatan - Global QR
      let globalCashVal = t.revenue - globalQRVal;
      // Opsional: Cegah minus jika QR input > Revenue (tergantung kebijakan)
      // if(globalCashVal < 0) globalCashVal = 0; 

      // Update Input Global Cash di Tabel
      document.getElementById("globalCash").value = formatNumber(globalCashVal);

      // --- UPDATE FOOTER ---
      const fields = [
        ["grandOldStock", t.oldStock], ["grandNewStock", t.newStock],
        ["grandTotalRefill", t.totalRefill], ["grandTotalStart", t.totalStart],
        ["grandRemainOld", t.remainOld], ["grandRemainNew", t.remainNew],
        ["grandTotalRemain", t.totalRemain], ["grandTotalSold", t.sold],
        ["grandTotalRevenue", t.revenue], 
        ["grandTotalCash", globalCashVal], // Ambil dari hasil hitungan baru
        ["grandTotalQR", globalQRVal]      // Ambil dari input user
      ];

      fields.forEach(([id,val])=>{
        const el = document.getElementById(id);
        const newVal = formatNumber(val);
        if(el && el.textContent !== newVal){
          el.textContent = newVal;
          el.classList.add("highlight");
          setTimeout(()=>el.classList.remove("highlight"),600);
        }
      });

      calculateMinus();
    }

    function calculateMinus(){
      const grandCashEl = document.getElementById("grandTotalCash");
      const cashTotal = unformatNumber(grandCashEl ? grandCashEl.textContent : "0");
      const diterima = unformatNumber(document.getElementById("cashDiterima").value);
      const cashbon = unformatNumber(document.getElementById("cashbon").value);
      let minus = 0, plus = 0;
      if(cashTotal > diterima + cashbon) minus = cashTotal - diterima - cashbon;
      if(diterima > cashTotal + cashbon) plus = diterima - cashTotal - cashbon;

      const m = document.getElementById("minus"); if(m) { m.value = formatNumber(minus); }
      const p = document.getElementById("plus"); if(p) p.value = plus > 0 ? formatNumber(plus) : "0";
    }

    /* ========== Validation + Save (unchanged behaviour) ========== */
    async function validateAndSave(){
      const required = [
        {id:"outletSelect",label:"Outlet"},
        {id:"riderName",label:"Nama Rider"},
        {id:"location",label:"Lokasi"},
        {id:"noGerobak",label:"No Gerobak"},
        {id:"adminCheckedBy",label:"Admin Checked By"},
        {id:"cashDiterima",label:"Cash Diterima"}
      ];
      for(const r of required){
        const el = document.getElementById(r.id);
        if(!el || !el.value || !el.value.toString().trim()){
          await Swal.fire({title:"Data Belum Lengkap",text:`Kolom ${r.label} wajib diisi.`,icon:"warning",confirmButtonColor:"#795548"});
          if(el) el.focus();
          return;
        }
      }
      if(document.querySelectorAll(".invalid").length > 0){ Swal.fire("Error","Ada kolom yang berisi nilai tidak valid!","error"); return; }

      const { isConfirmed } = await Swal.fire({
        title: "Konfirmasi Kehadiran Besok",
        text: "Apakah kamu akan narik/hadir besok?",
        icon: "question",
        showCancelButton: true,
        confirmButtonText: "Narik",
        cancelButtonText: "Tidak Narik",
        confirmButtonColor: "#43a047",
        cancelButtonColor: "#c62828",
        allowOutsideClick: false, allowEscapeKey:false, allowEnterKey:false
      });

      const kehadiran = isConfirmed ? "Narik" : "Tidak Narik";
      saveData(kehadiran);
    }

/* --- MODIFIED: SAVE DATA (Handle merged inputs) --- */
    function saveData(kehadiran){
      const btn = document.getElementById("saveBtn"); if(btn){ btn.disabled = true; btn.style.opacity = "0.5"; }
      const statusEl = document.getElementById("status"); if(statusEl) statusEl.textContent = "‚è≥ Menyimpan data...";

      // Ambil nilai Global
      const globalCashVal = unformatNumber(document.getElementById("globalCash").value);
      const globalQRVal = unformatNumber(document.getElementById("globalQR").value);

      const data = {
        outlet: document.getElementById("outletSelect").value,
        riderName: document.getElementById("riderName").value,
        location: document.getElementById("location").value,
        noGerobak: document.getElementById("noGerobak").value,
        date: document.getElementById("date").value,
        adminChecked: document.getElementById("adminCheckedBy").value,
        cashDiterima: unformatNumber(document.getElementById("cashDiterima").value),
        cashbon: unformatNumber(document.getElementById("cashbon").value),
        minus: unformatNumber(document.getElementById("minus").value),
        plus: unformatNumber(document.getElementById("plus").value),
        notesRider: document.getElementById("notesRider").value,
        timestamp: new Date().toLocaleString("id-ID",{timeZone:"Asia/Jakarta"}),
        kehadiran,
        
        products: [...document.querySelectorAll("#tableBody tr")].map((r, index)=>({
          product: r.cells[0].textContent,
          price: unformatNumber(r.querySelector(".price").value),
          oldStock: unformatNumber(r.querySelector(".oldStock").value),
          newStock: unformatNumber(r.querySelector(".newStock").value),
          totalStart: unformatNumber(r.querySelector(".totalStart").value),
          remainOld: unformatNumber(r.querySelector(".remainOld").value),
          remainNew: unformatNumber(r.querySelector(".remainNew").value),
          totalRemain: unformatNumber(r.querySelector(".totalRemain").value),
          sold: unformatNumber(r.querySelector(".sold").value),
          revenue: unformatNumber(r.querySelector(".revenue").value),
          
          /* TRICKY PART:
             Karena data di backend biasanya butuh angka per produk, tapi kita cuma punya global.
             Strategi: Masukkan Total Cash & QR ke produk PERTAMA saja, sisanya 0.
             Ini agar Grand Total di backend (kalau ada rumus sum) tetap valid.
          */
          qr: (index === 0) ? globalQRVal : 0,
          cash: (index === 0) ? globalCashVal : 0,

          notes: r.querySelector(".notes").value
        }))
      };

      google.script.run
        .withSuccessHandler(msg=>{
          Swal.fire({title:"Berhasil!",html:`Data berhasil disimpan.<br><b>Kehadiran besok:</b> ${kehadiran}`,icon:"success",timer:2200,showConfirmButton:false});
          showPopup(`Data berhasil disimpan (${kehadiran})`);
          const statusEl2 = document.getElementById("status"); if(statusEl2) statusEl2.textContent = msg;
          resetForm(); // Auto reset setelah save
        })
        .withFailureHandler(err=>{
          Swal.fire("Gagal!", err.message, "error");
          const statusEl3 = document.getElementById("status"); if(statusEl3) statusEl3.textContent = "‚ùå " + err.message;
          if(btn){ btn.disabled = false; btn.style.opacity = "1"; }
        })
        .saveRiderData(data);
    }
    function showPopup(msg){ const pop = document.getElementById("popup"); pop.textContent = msg; pop.classList.add("show"); setTimeout(()=>pop.classList.remove("show"),3000); }

/* --- MODIFIED: RESET FORM --- */
    function resetForm(){
      // Reset input baris produk
      document.querySelectorAll("#tableBody input, #tableBody textarea").forEach(e=>{ 
         if(!e.classList.contains("price") && e.id !== "globalCash" && e.id !== "globalQR") e.value = ""; 
      });
      
      // Reset Global Inputs
      document.getElementById("globalCash").value = "";
      document.getElementById("globalQR").value = "";

      document.querySelectorAll("tfoot td[id]").forEach(td=>td.textContent="0");
      ["riderName","location","cashDiterima","cashbon","minus"].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=""; });
      const g = document.getElementById("noGerobak"); if(g) g.value = "ECL-";
      const dateEl = document.getElementById("date"); if (dateEl) dateEl.value = todayLocal();

      const cb = document.getElementById("cashbon"); if(cb) cb.value = "0";
      const p = document.getElementById("plus"); if(p) p.value = "0";
      const notes = document.getElementById("notesRider"); if(notes) notes.value = "";
      const outlet = document.getElementById("outletSelect"); if(outlet) outlet.value = "";
      const btn = document.getElementById("saveBtn"); if(btn){ btn.disabled = false; btn.style.opacity = "1"; }
      const statusEl = document.getElementById("status"); if(statusEl) statusEl.textContent = "";
      
      MASTER.refillByProduct = {};
      updateRefillOnProducts();
      updateGrandTotal();
    }

    window.addEventListener("scroll", ()=>{ const b = document.querySelector(".floating-save"); b.style.display = window.scrollY > 400 ? "block" : "none"; });

    /* ========== SIDEBAR logic ========== */
    const historiBtn = document.getElementById("historiBtn");
    const sidebar = document.getElementById("refillSidebar");
    const overlay = document.getElementById("refillOverlay");
    historiBtn.addEventListener("click", openRefillSidebar);

    function openRefillSidebar(){
      sidebar.classList.add("open");
      document.body.classList.add("refill-open");
      sidebar.setAttribute("aria-hidden","false");
      loadRefillHistory(); // load using current rider & date
    }

    function closeRefillSidebar(){
      sidebar.classList.remove("open");
      document.body.classList.remove("refill-open");
      sidebar.setAttribute("aria-hidden","true");
    }

    // reload when rider/date changes
    document.getElementById("riderName").addEventListener("change", loadRefillHistory);
    document.getElementById("date").addEventListener("change", loadRefillHistory);

    function loadRefillHistory(){
      const rider = document.getElementById("riderName").value;
      const date = document.getElementById("date").value;
      const summaryEl = document.getElementById("refillSummary");
      const listEl = document.getElementById("refillList");
      const productBox = document.getElementById("productSummaryBox");
      if(!rider || !date){
        summaryEl.innerHTML = "Pilih Rider & Tanggal untuk melihat histori refill.";
        listEl.innerHTML = "";
        productBox.style.display = "none";
        MASTER.refillByProduct = {};
        updateRefillOnProducts();
        updateGrandTotal();
        return;
      }

      // call backend Apps Script function getRefillHistory(dateFrom, dateTo, by, value)
      google.script.run.withSuccessHandler(renderRefillHistory).getRefillHistory(date, date, "rider", rider);
    }

    /* ========== renderRefillHistory
         - builds MASTER.refillByProduct (daily sums)
         - updates sidebar UI
         - updates table refill fields and recalculations
    */
    /* =========================================
       FIX: PARSER PECAHAN (1/2, 1/4)
       Tambahkan function ini agar tidak NaN
    ========================================= */
    function parseRefillQty(val) {
      if (!val) return 0;
      // Jika tipe datanya sudah angka, langsung return
      if (typeof val === 'number') return val;
      
      const v = String(val).trim();
      if (v === '1/4') return 0.25;
      if (v === '1/2') return 0.5;
      if (v === '3/4') return 0.75;
      if (v === '1') return 1;
      
      // Coba parse float biasa
      return parseFloat(v) || 0;
    }

function renderRefillHistory(rows){
      const summaryEl = document.getElementById("refillSummary");
      const listEl = document.getElementById("refillList");
      const productBox = document.getElementById("productSummaryBox");

      // reset mapping
      MASTER.refillByProduct = {};

      if(!rows || rows.length === 0){
        summaryEl.innerHTML = `<div style="padding:18px;text-align:center;color:#5d4037">Tidak ada histori refill.</div>`;
        listEl.innerHTML = "";
        productBox.style.display = "none";
        updateRefillOnProducts();
        updateGrandTotal();
        return;
      }

      // --- LOGIK PERHITUNGAN BARU ---
      let totalCups = 0;
      let totalEsBatu = 0;

      rows.forEach(r=>{
        const prod = r.product || "Unknown";
        // Gunakan parser supaya "1/2" jadi 0.5 (Tidak NaN)
        const q = parseRefillQty(r.qty); 

        // Masukkan ke Master Data agar tabel stok tetap terupdate
        if(!MASTER.refillByProduct[prod]) MASTER.refillByProduct[prod] = 0;
        MASTER.refillByProduct[prod] += q;

        // Pisahkan hitungan Es Batu vs Cup
        if(prod === "Es Batu") {
            totalEsBatu += q;
        } else {
            totalCups += q;
        }
      });

      const first = rows[0];

      // Build Summary HTML Produk
      let productSummaryHTML = "";
      Object.keys(MASTER.refillByProduct).forEach(k=>{
        // Tampilan khusus Es Batu pakai satuan 'bal/pack' atau biarkan desimal
        const unit = (k === "Es Batu") ? "pack/bal" : "cup";
        productSummaryHTML += `
            <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:13px;">
                <span>${k}</span>
                <strong>${MASTER.refillByProduct[k]} ${unit}</strong>
            </div>`;
      });

      // Tampilan Total Es Batu (Jika ada)
      let esBatuDisplay = "";
      if (totalEsBatu > 0) {
        esBatuDisplay = `
        <div style="font-weight:600;color:#1976D2;margin-top:4px;">
           ‚ùÑÔ∏è Es Batu: <span style="float:right">${totalEsBatu} pack</span>
        </div>`;
      }

      summaryEl.innerHTML = `
        <div style="padding:12px;background:#efebe9;border-radius:10px;">
          
          <div style="font-weight:600;color:#4e342e;font-size:15px;">
             üì¶ Total Refill (Cup):
            <span style="float:right;font-size:16px;">${totalCups} cup</span>
          </div>

          ${esBatuDisplay}

          <div style="margin-top:10px;font-weight:600;color:#4e342e;border-top:1px dashed #ccc;padding-top:8px;">
            Ringkasan Produk:
          </div>
          ${productSummaryHTML}

          <hr style="border:0;border-top:1px solid #d7ccc8;margin:10px 0;">

          <div style="margin-top:6px;color:#5d4037;">üìç Outlet: <span style="float:right">${first.outlet || "-"}</span></div>
          <div style="margin-top:6px;color:#5d4037;">üë§ Rider: <span style="float:right">${first.rider || "-"}</span></div>
          <div style="margin-top:6px;color:#5d4037;">üóì Tanggal: <span style="float:right">${(first.date||"").split(" ")[0] || "-"}</span></div>
        </div>
      `;

      // detailed list
      let detailHTML = "";
      rows.forEach(item=>{
        detailHTML += `
          <div class="refill-item">
            <div style="font-weight:700;margin-bottom:6px;">${item.product}</div>
            <div>Qty: ${item.qty}</div>
            <div style="font-size:12px;color:#6d4c41;margin-top:6px;">${item.date} ‚Äî ${item.admin}</div>
            ${item.notes ? `<div style="margin-top:8px;">üìù ${item.notes}</div>` : ""}
          </div>
        `;
      });

      listEl.innerHTML = detailHTML;

      // Update tabel input
      updateRefillOnProducts();
      updateGrandTotal();
    }

    /* updateRefillOnProducts:
       - set .totalRefill for each product row from MASTER.refillByProduct
       - recalc row (calculateRow) to include refill
    */
    function updateRefillOnProducts(){
      document.querySelectorAll("#tableBody tr").forEach(r=>{
        const prod = r.querySelector(".prod-name").textContent;
        const refillQty = Number(MASTER.refillByProduct && MASTER.refillByProduct[prod] ? MASTER.refillByProduct[prod] : 0);
        const refillEl = r.querySelector(".totalRefill");
        if(refillEl) refillEl.value = formatNumber(refillQty);
        // recalc row using updated refill
        calculateRow(r);
      });
      // refresh grand totals after update
      updateGrandTotal();
    }

    /* ========== misc visuals ========== */
    window.addEventListener("resize", adjustSidebarHeight);
    window.addEventListener("load", adjustSidebarHeight);
    function adjustSidebarHeight(){
      const form = document.querySelector(".form-container");
      const sidebar = document.getElementById("refillSidebar");
      if(!form || !sidebar) return;
      // keep sidebar height sane on various screens
      sidebar.style.maxHeight = Math.min(window.innerHeight, form.offsetHeight + 80) + "px";
    }

  </script>
</body>
</html>
